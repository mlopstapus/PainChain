// PainChain v2 Database Schema
// Multi-tenant event aggregation platform

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// Multi-tenant support (for SaaS tier)
model Tenant {
  id            String   @id @default(cuid())
  slug          String   @unique  // "customer-id" for customer-id.painchain.io
  name          String
  createdAt     DateTime @default(now())

  integrations  Integration[]
  events        Event[]
  projects      Project[]
  teams         Team[]

  @@map("tenants")
}

// User-registered integrations (SaaS tier: users provide API keys)
// Or connector instances (Free tier: running containers)
model Integration {
  id            String   @id @default(cuid())
  tenantId      String?  // null for free tier (single tenant)
  tenant        Tenant?  @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  type          String   // "github", "gitlab", "kubernetes"
  name          String   // User-friendly name: "ACME GitHub", "Production K8s"

  // Configuration (API keys, repos to watch, polling settings)
  config        Json     // { token: "...", repositories: [...], polling: {...} }

  // Status
  status        String   @default("active") // "active", "inactive", "error"
  lastSync      DateTime?
  registeredAt  DateTime @default(now())

  events        Event[]  // Events created by this integration

  @@map("integrations")
}

model Event {
  id            String   @id @default(cuid())
  tenantId      String?  // null for free tier
  tenant        Tenant?  @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  integrationId String?       // Which integration created this event
  integration   Integration?  @relation(fields: [integrationId], references: [id], onDelete: SetNull)

  externalId    String?  // Source system ID for deduplication (e.g., github-event-123)

  title         String
  connector     String   // "github", "gitlab", "kubernetes"
  project       String   // "acme/backend-api", "prod-cluster/default"
  timestamp     DateTime
  data          Json     // Flexible JSON data
  createdAt     DateTime @default(now())

  @@unique([integrationId, externalId], name: "integration_external_id")
  @@index([tenantId, connector, project, timestamp])
  @@index([tenantId, timestamp])
  @@index([timestamp])
  @@index([integrationId])
  @@index([externalId])
  @@map("events")
}

model Project {
  id          String   @id @default(cuid())
  tenantId    String?  // null for free tier
  tenant      Tenant?  @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  name        String   // "acme/backend-api", "prod-cluster/default"
  connector   String   // "github", "gitlab", "kubernetes"
  tags        String[] // Tags defined in connector config for this project
  createdAt   DateTime @default(now())

  @@unique([tenantId, name, connector])
  @@map("projects")
}

// Connector type metadata (self-registered by connectors on startup)
model ConnectorType {
  id            String   @id // "github", "gitlab", "kubernetes"
  displayName   String
  color         String?  // Hex color for UI badges
  logo          String?  // Logo filename
  description   String?
  configSchema  Json     // JSON schema for integration configuration form
  registeredAt  DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@map("connector_types")
}

// Teams for organizing integrations by tags
model Team {
  id          String   @id @default(cuid())
  tenantId    String?
  tenant      Tenant?  @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  name        String   // Immutable team name (becomes first tag)
  tags        String[] // Additional tags for filtering
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([tenantId, name])
  @@index([tenantId])
  @@map("teams")
}
